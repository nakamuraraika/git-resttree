# インストール方法

1. リポジトリをクローンします
```bash
git clone https://github.com/nakamuraraika/git-resttree.git
cd git-resttree
```

2. 実行権限を付与します
```bash
chmod +x git-resttree
```

3. パスが通ったディレクトリに配置します
```bash
# 例: /usr/local/bin に配置
sudo cp git-resttree /usr/local/bin/

# または ~/.local/bin に配置（~/.local/bin がパスに含まれている場合）
cp git-resttree ~/.local/bin/
```

4. インストール確認
```bash
git-resttree
```

# 仕様書

## 概要
**目的**: git worktreeを活用した複数ブランチの同時編集環境構築ツール

## 詳細仕様

### 処理フロー
```
1. ブランチ選択フェーズ
2. 作業ツリー存在チェック
3. ブランチ存在チェック・新規作成
4. パス指定フェーズ
5. 作業ツリー作成
6. アプリ選択・起動フェーズ
```

### 各フェーズの詳細

#### ブランチ選択フェーズ
- **UI**: pecoによるfuzzy finder
- **データソース**
  - `git branch --format='%(refname:short)'`
- **オプション**: `--print-query`で新規ブランチ名の直接入力対応
- **表示メッセージ**: 「ブランチを選択してください（新規ブランチ名も直接入力可能）:」
- **出力**: 選択/入力されたブランチ名（`tail -n 1`で最終行取得）

#### 作業ツリー存在チェック
- **概要**: 指定したブランチの作業ツリーが既に存在する場合、パス指定と作業ツリー作成をスキップしてアプリ選択・起動フェーズまで進む
- **チェック方法**: `git worktree list`で既存の作業ツリー一覧を取得
- **マッチング**: ブランチ名と作業ツリーのブランチを照合
- **存在時の処理**:
  - 既存パスを取得: 作業ツリーのパスを`WORKTREE_PATH`に設定
  - メッセージ表示: 「作業ツリーが既に存在します: {パス}」
  - フローのスキップ: パス指定フェーズと作業ツリー作成フェーズをバイパス

#### ブランチ存在チェック・新規作成
- **チェック方法**: `git show-ref --verify --quiet refs/heads/{ブランチ名}`
- **新規作成時**:
  - 確認メッセージ: 「ブランチ '{ブランチ名}' が存在しません。新規作成しますか？ (y/N)」
  - 作成コマンド: `git checkout -b {ブランチ名}`
  - エラー時: 処理中止

#### パス指定フェーズ
- **表示メッセージ**: 「パスを指定してください」
- **サブメッセージ**: 「（空白でブランチ名をパスとして使用します）」
- **入力方法**: `read -r PATH_INPUT`
- **パス**: 
  - 環境変数`WORKTREE_DIR`が設定されている場合: `{WORKTREE_DIR}/${PATH_INPUT or BRANCH}`
  - 未設定の場合: `${PATH_INPUT or BRANCH}`
- **環境変数対応**: `WORKTREE_DIR`で作業フォルダ名を指定可能
- **ループ処理**: エラー時は再入力

#### 作業ツリー作成
- **実行コマンド**: `git worktree add {パス} {ブランチ名}`
- **成功時**: 「作業ツリーが正常に追加されました: {パス}」
- **エラー時**: 「エラー: 作業ツリーの追加に失敗しました」→ パス指定フェーズに戻る

#### アプリ選択・起動フェーズ
- **UI**: bashの`select`コマンド
- **プロンプト**: `PS3="選択してください: "`
- **選択肢**:
  | 選択肢 | 動作 | コマンド |
  |--------|------|----------|
  | 選択しない | 何もしない | - |
  | Terminal | 新しいシェルで移動 | `cd {パス} && exec $SHELL` |
  | Cursor | Cursorエディタで開く | `cursor {パス}` |
  | IntelliJ IDEA | IntelliJ IDEAで開く | `open -na "IntelliJ IDEA Ultimate.app" --args nosplash {パス}` |

## エラーハンドリング
- **peco未インストール**: 「エラー: pecoがインストールされていません」→ 終了
- **ブランチ未選択**: 「ブランチが選択されませんでした」→ 終了
- **ブランチ作成失敗**: 「エラー: ブランチの作成に失敗しました」→ 終了
- **作業ツリー作成失敗**: 「エラー: 作業ツリーの追加に失敗しました」→ パス指定に戻る
- **無効な選択**: 「無効な選択です。もう一度選択してください。」→ 再選択

## 依存関係
- **必須**: peco（fuzzy finder）
- **推奨**: Cursor、IntelliJ IDEA（アプリ選択で使用）

---

## 技術仕様

### 使用技術
- **言語**: bash
- **外部ツール**: git, peco
- **実行権限**: `chmod +x git-resttree`
- **環境変数**: `WORKTREE_DIR`（作業フォルダの一元管理）

### 実行方法
```
git worktree
```

---

## 環境変数

### WORKTREE_DIR

作業ツリーを一元管理するためのディレクトリを指定できます。

```bash
# 環境変数を設定
export WORKTREE_DIR="worktrees"
```

**設定効果:**
- パス指定時に`WORKTREE_DIR`の値がデフォルトで入力される
- 全ての作業ツリーを指定したディレクトリ下に整理できる
- 未設定の場合は、現在のディレクトリが基準となる

**設定例:**
```bash
# ~/.bashrc または ~/.zshrc に追加
export WORKTREE_DIR="worktrees"
```

**使用時の動作:**
- `WORKTREE_DIR="worktrees"`設定時
- パスに`hoge`を指定
- `worktrees/{ブランチ名}`に作業ツリーが作成される